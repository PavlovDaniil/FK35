<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование файла</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #fileContent { width: 100%; height: 300px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; white-space: pre-wrap; overflow-y: auto; }
        button { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: 1px solid #008cff; background: #008cff; color: white; margin-top: 10px; }
        button:hover { background: #006fcc; }
        .placeholder-field { margin-bottom: 10px; }
        .placeholder-field input { width: 300px; padding: 4px; border-radius: 3px; border: 1px solid #ccc; }
        .placeholder-field label { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Редактирование файла</h1>
    <p id="filename"></p>

    <div id="fileContent"></div>

    <h2>Заполните плейсхолдеры</h2>
    <div id="placeholdersContainer"></div>

    <button id="saveBtn">Сохранить изменения</button>

    <script>
        const params = new URLSearchParams(window.location.search);
        const file = params.get("file");
        document.getElementById("filename").textContent = `Файл: ${file}`;

        const fileContentDiv = document.getElementById("fileContent");
        const placeholdersContainer = document.getElementById("placeholdersContainer");

        let originalText = ""; // текст файла с {{placeholder}}

        async function loadFile() {
            const response = await fetch(`http://localhost:8000/files/${encodeURIComponent(file)}`);
            const data = await response.json();
            originalText = data.content;
            fileContentDiv.textContent = originalText;
        }

        async function loadPlaceholders() {
            const res = await fetch(`http://localhost:8000/files/placeholders/${encodeURIComponent(file)}`);
            const data = await res.json(); // { placeholders: [...] }

            placeholdersContainer.innerHTML = "";

            data.placeholders.forEach(ph => {
                const div = document.createElement("div");
                div.className = "placeholder-field";

                const label = document.createElement("label");
                label.textContent = ph + ": ";

                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = `Введите значение для {{${ph}}}`;
                input.id = ph;

                input.addEventListener("input", updateFileContent);

                div.appendChild(label);
                div.appendChild(input);
                placeholdersContainer.appendChild(div);
            });
        }

        function updateFileContent() {
            let text = originalText;
            const inputs = placeholdersContainer.querySelectorAll("input");

            inputs.forEach(input => {
                const key = input.id;
                const value = input.value;
                const regex = new RegExp(`{{\\s*${key}\\s*}}`, "g");
                text = text.replace(regex, value);
            });

            fileContentDiv.textContent = text;
        }

document.getElementById("saveBtn").onclick = async () => {
    const inputs = placeholdersContainer.querySelectorAll("input");
    const data = {};

    // собираем только плейсхолдеры и их значения
    inputs.forEach(input => {
        const key = input.id;
        const value = input.value;
        data[key] = value;
    });

    // отправляем на сервер
    const response = await fetch(`http://localhost:8000/files/${encodeURIComponent(file)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    if (response.ok) {
        // получаем PDF как blob
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        // создаём временную ссылку для скачивания
        const a = document.createElement("a");
        a.href = url;
        a.download = file.replace(".docx", ".pdf"); // имя скачиваемого файла
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url); // освобождаем память
    } else {
        const err = await response.json();
        alert("Ошибка: " + err.detail);
    }
};

    
        // загрузка файла и плейсхолдеров при открытии страницы
        loadFile();
        loadPlaceholders();

    </script>
</body>
</html>
